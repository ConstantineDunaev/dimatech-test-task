# Тестовое задание Dimatech

## Техническое задание:

Необходимо реализовать асинхронное веб приложение в парадигме REST API.

Время выполнения задачи 5 дней.

Стек:
- База данных - postgresql
- sqlalchemy - для работы с базой данных
- sanic - веб фреймворк(рекомендуемый, допускается альтернативный веб фрейморк НО НЕ DJANGO)
- docker compose

Необходимо реализовать работу со следующими сущностями:
- Пользователь
- Администратор
- Счет - имеет баланс, привязан к пользователю
- Платеж(пополнение баланса) - хранит уникальный идентификатор и сумму пополнения счета пользователя

Пользователь должен иметь следующие возможности:
- Авторизоваться по email/password
- Получить данные о себе(id, email, full_name)
- Получить список своих счетов и балансов
- Получить список своих платежей

Администратор должен иметь следующие возможности:
- Авторизоваться по email/password
- Получить данные о себе (id, email, full_name)
- Создать/Удалить/Обновить пользователя
- Получить список пользователей и список его счетов с балансами

Для работы с платежами должен быть реализован роут эмулирующий обработку вебхука от сторонней платежной системы.
Структура json-объекта для обработки вебхука должна состоять из следующих полей:
- `transaction_id` - уникальный идентификатор транзакции в “сторонней системе”
- `account_id` - уникальный идентификатор счета пользователя
- `user_id` - уникальный идентификатор счета пользователя
- `amount` - сумма пополнения счета пользователя
- `signature` - подпись объекта

signature должна формироваться через SHA256 хеш, для строки состоящей из конкатенации значений объекта в алфавитном порядке ключей и “секретного ключа” хранящегося в конфигурации проекта (`{account_id}{amount}{transaction_id}{user_id}{secret_key}`). 

Пример, для secret_key gfdmhghif38yrf9ew0jkf32:
```
{
  "transaction_id": "5eae174f-7cd0-472c-bd36-35660f00132b",
  "user_id": 1,
  "account_id": 1,
  "amount": 100,
  "signature": "7b47e41efe564a062029da3367bde8844bea0fb049f894687cee5d57f2858bc8"
}
```

При обработке вебхука необходимо:
- Проверить подпись объекта
- Проверить существует ли у пользователя такой счет - если нет, его необходимо создать
- Сохранить транзакцию в базе данных
- Начислить сумму транзакции на счет пользователя

Транзакции являются уникальными, начисление суммы с одним transaction_id должно производиться только один раз.

Для тестирования приложения в миграции должен быть создан:
- Тестовый пользователь
- Счет тестового пользователя
- Тестовый администратор

Для развертывания проекта необходимо реализовать docker compose конфигурацию состоящую из сервиса postgresql и сервиса приложения.
К реализованному заданию должна прилагаться краткая инструкция по запуску проекта в двух вариантах - с использованием docker compose и без него. В инструкции также должны быть предоставлены email/password для пользователя и администратора по умолчанию созданных в миграции.

## Переменные окружения

 - `POSTGRES_HOST` - хост PostgreSQL
 - `POSTGRES_PORT` - порт PostgreSQL
 - `POSTGRES_USER` - пользователь PostgreSQL
 - `POSTGRES_PASSWORD` - пароль пользователя PostgreSQL
 - `POSTGRES_DATABASE` - имя базы данных PostgreSQL
 - `SECRET_KEY` - секретный ключ, используемый для подписи транзакций

## Установка и запуск

### С использованием docker-compose

### Без использования docker-compose

```commandline
git clone git@github.com:ConstantineDunaev/dimatech-test-task.git
cd dimatech-test-task
python3 -m venv venv
source venv/bin/activate
pip install -r requirements.txt
alembic upgrade head
uvicorn app.main:app --host 0.0.0.0 --port 8000 --log-config logging.yaml
```

## Документация API

Документация API доступна по адресу `/redoc`

## Тестовые данные для аутентификации
Данные пользователя необходимо передавать в HTTP заголовках `email` и `password`.

### Администратор
- email: admin@example.com 
- пароль: admin_password

### Пользователь
- email: user1@example.com
- пароль: user1_password

## Пример готовых транзакций для теста
Для формирования подписи используется секретный ключ `gfdmhghif38yrf9ew0jkf32`
```
{
  "transaction_id": "3f1e2a7c-9d4b-4f06-b8a7-2c8e5e2a19d1",
  "user_id": 2,
  "account_id": 1,
  "amount": 500,
  "signature": "db2e501221836f7f8c0922fc7ca205a384cbdcb9c7da3e618c0480d83533cef1"
}
```

```
{
  "transaction_id": "d2f3c4e5-6b7a-48f1-9e3b-0a1f2d3e4c5b",
  "user_id": 2,
  "account_id": 2,
  "amount": 350,
  "signature": "e0d3d801b22992579b98da303a4584a8a87b8bb9f44a88e531dfe90b66f231b1"
}
```

```
{
  "transaction_id": "7a9d3f1e-2b4c-4d06-8f7e-5c9a1b2d3e4f",
  "user_id": 2,
  "account_id": 2,
  "amount": 200.99,
  "signature": "4a3305ef1757f0559f8858432164c8b119f2176e5cd5ce728a73e6136845156c"
}
```